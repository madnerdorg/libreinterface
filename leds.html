<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">
	<title>Leds Demonstration</title>

	<!-- CSS -->
	<link rel="stylesheet" href="core/lib/Semantic-UI-CSS-master/semantic.min.css">
	<link rel="stylesheet" href="core/lib/codemirror/codemirror.css">
	<link rel="stylesheet" href="core/lib/codemirror/theme/zenburn.css">
	<link rel="stylesheet" href="core/lib/highlight/styles/zenburn.css">
	<link rel="stylesheet" href="core/lib/range/range.css">


	<!-- Semantic UI --> 
	<script src="core/lib/jquery/jquery-3.1.1.min.js"></script>
	<script src="core/lib/Semantic-UI-CSS-master/semantic.min.js"></script>

	<!-- Markdown -->
	<script src="core/lib/markdown-browser-0.6.0-beta1/markdown.min.js"></script>
	<!-- Code Mirror -->
	<script src="core/lib/codemirror/codemirror.js"></script>
	<!-- Syntax Highlight for Js/css/html -->
	<script src="core/lib/codemirror/javascript/javascript.js"></script>
	<script src="core/lib/codemirror/css/css.js"></script>
	<script src="core/lib/codemirror/xml/xml.js"></script>
	<script src="core/lib/codemirror/htmlmixed/htmlmixed.js"></script>
	<!-- Hightlight.js -->
	<script src="core/lib/highlight/highlight.pack.js"></script>
	<script src="core/lib/range/range.js"></script>

	<!-- Connector -->
	<script src="core/lib/reconnecting-websocket/reconnecting-websocket.min.js"></script>
	<script src="core/websockets.js"></script>

</head>



<body>

	<!-- Test -->
	<div class="ui container">

		<!-- Tab Test -->
		<div class="ui raised very padded text container segment">
			<div class="ui header state_arduino label green">Arduino</div>

			<div class="ui inverted segment">
				<button id="led0" class="circular ui icon button" style="background-color: black;"></button>
				<button id="led1" class="circular ui icon button" style="background-color: black;"></button>
				<button id="led2" class="circular ui icon button" style="background-color: black;"></button>
				<button id="led3" class="circular ui icon button" style="background-color: black;"></button>
				<button id="led4" class="circular ui icon button" style="background-color: black;"></button>
			</div>
			<div class="ui segment">
			<div class="ui buttons">
				<button onclick="leds.send(0)" class="ui button red">Turn off</button>
				<button onclick="animateLeds(500)" class="ui button green">Animate</button>
				</div>
				<div class="ui range" id="speed-range"></div>
		
			<div class="ui inverted segment">
			<br>
			<button onclick="change_color(1,0)" class="circular ui icon button" style="background-color: black;"></button>
			<button onclick="change_color(1,1)" class="circular ui icon button" style="background-color: white;"></button>
			<button onclick="change_color(1,2)" class="circular ui icon button" style="background-color: red;"></button>
			<button onclick="change_color(1,3)" class="circular ui icon button" style="background-color: green;"></button>
			<button onclick="change_color(1,4)" class="circular ui icon button" style="background-color: blue;"></button>
			<button onclick="change_color(1,5)" class="circular ui icon button" style="background-color: yellow;"></button>
			<button onclick="change_color(1,6)" class="circular ui icon button" style="background-color: orange;"></button>
			<button onclick="change_color(1,7)" class="circular ui icon button" style="background-color: purple;"></button>
			<br>
			<button onclick="change_color(2,0)" class="circular ui icon button" style="background-color: black;"></button>
			<button onclick="change_color(2,1)" class="circular ui icon button" style="background-color: white;"></button>
			<button onclick="change_color(2,2)" class="circular ui icon button" style="background-color: red;"></button>
			<button onclick="change_color(2,3)" class="circular ui icon button" style="background-color: green;"></button>
			<button onclick="change_color(2,4)" class="circular ui icon button" style="background-color: blue;"></button>
			<button onclick="change_color(2,5)" class="circular ui icon button" style="background-color: yellow;"></button>
			<button onclick="change_color(2,6)" class="circular ui icon button" style="background-color: orange;"></button>
			<button onclick="change_color(2,7)" class="circular ui icon button" style="background-color: purple;"></button>
			<br>
			<button onclick="change_color(3,0)" class="circular ui icon button" style="background-color: black;"></button>
			<button onclick="change_color(3,1)" class="circular ui icon button" style="background-color: white;"></button>
			<button onclick="change_color(3,2)" class="circular ui icon button" style="background-color: red;"></button>
			<button onclick="change_color(3,3)" class="circular ui icon button" style="background-color: green;"></button>
			<button onclick="change_color(3,4)" class="circular ui icon button" style="background-color: blue;"></button>
			<button onclick="change_color(3,5)" class="circular ui icon button" style="background-color: yellow;"></button>
			<button onclick="change_color(3,6)" class="circular ui icon button" style="background-color: orange;"></button>
			<button onclick="change_color(3,7)" class="circular ui icon button" style="background-color: purple;"></button>
			<br>
			<button onclick="change_color(4,0)" class="circular ui icon button" style="background-color: black;"></button>
			<button onclick="change_color(4,1)" class="circular ui icon button" style="background-color: white;"></button>
			<button onclick="change_color(4,2)" class="circular ui icon button" style="background-color: red;"></button>
			<button onclick="change_color(4,3)" class="circular ui icon button" style="background-color: green;"></button>
			<button onclick="change_color(4,4)" class="circular ui icon button" style="background-color: blue;"></button>
			<button onclick="change_color(4,5)" class="circular ui icon button" style="background-color: yellow;"></button>
			<button onclick="change_color(4,6)" class="circular ui icon button" style="background-color: orange;"></button>
			<button onclick="change_color(4,7)" class="circular ui icon button" style="background-color: purple;"></button>
			<br>
			<button onclick="change_color(5,0)" class="circular ui icon button" style="background-color: black;"></button>
			<button onclick="change_color(5,1)" class="circular ui icon button" style="background-color: white;"></button>
			<button onclick="change_color(5,2)" class="circular ui icon button" style="background-color: red;"></button>
			<button onclick="change_color(5,3)" class="circular ui icon button" style="background-color: green;"></button>
			<button onclick="change_color(5,4)" class="circular ui icon button" style="background-color: blue;"></button>
			<button onclick="change_color(5,5)" class="circular ui icon button" style="background-color: yellow;"></button>
			<button onclick="change_color(5,6)" class="circular ui icon button" style="background-color: orange;"></button>
			<button onclick="change_color(5,7)" class="circular ui icon button" style="background-color: purple;"></button>

			</div>

		</div>

		<!-- Tab Configuration -->
		<div class="ui raised very padded text segment">
			<div class="ui styled accordion">
				<div class="title">
					<i class="dropdown icon"></i>Settings
				</div>

				<div class="content">
					<form class="ui form">
						<div class="field">
							<label>IP / Nom</label>
							<textarea id="ip" rows="1">pi.local</textarea>
						</div>
						<div class="field">
							<label>Port</label>
							<textarea id="port" rows="1">42001</textarea>
						</div>
					</form>
					<br>
					<button class="ui green button" onclick="sauvegarder()"><i class="big save icon"></i>Save</button>
					<button onclick="leds.send('@poweroff')" class="circular ui red icon button">Shutdown</button>
					<button onclick="leds.send('@reboot')" class="circular ui yellow button">Reboot</button>
				</div>

			</div>
		</div>
	</div>
	<br>
</body>
<script>

	$('#speed-range').range({
		min: 35,
		max:200,
		start: 100,
		onChange: function(val) { max_time = val; }
	});

  //We can the settings
  if(localStorage.leds_ip === undefined){
  	ip = $("#ip").val();
  	port = $("#port").val();
  } else {
  	ip = localStorage.getItem("leds_ip");
  	port = localStorage.getItem("leds_port");
  	$("#ip").val(ip);
  	$("#port").val(port);
  }
  console.log(ip);
  console.log(port);



  colorArray = ["black","white","red","green","blue","yellow","orange","purple"];
  ledState = ["0","0","0","0","0"];
  last_message = 0;
  max_time = 40;
  
  leds = new ReconnectingWebSocket('ws://'+ip+':'+port);
  
  function change_color(pos,color){
  	console.log(pos,color);
  	ledState[pos-1] = color;
  	var ledMessage = "";
  	console.log(ledState);
  	for (var i = 0; i < ledState.length; i++){
  		ledMessage = ledMessage + ledState[i];
  		if(i != (ledState.length - 1)){
  			ledMessage = ledMessage + ";"; 
  		}
  	}
  	console.log(ledMessage);
  	leds.send(ledMessage);
  }


  function animateLeds(){
  	var l = ["0","0","0","0","0"];
  	for(var position = 0;position <= 5;position++){
  		for(var color = 0;color <= 7;color++){
  			l[position] = color;
  			sync_send(l[0]+";"+l[1]+";"+l[2]+";"+l[3]+";"+l[4]);
  		}
  	}
  	sync_send("0");
  }

  function sync_send(message){

  	time = new Date();
  	time = ((time.getSeconds() * 1000) + time.getMilliseconds());
  	time_elapsed =  time - last_message;
  	if(time_elapsed < 0){
  		console.log("Error time, reset");
  		timed_elapsed = 0;
  		last_message = 0;
  	}
    //console.log("|||||" + time_elapsed);
    if(time_elapsed >= max_time){
    	leds.send(message);
    	last_message = time;
    	retry = 0;
    } else {     
    	console.log("===>"+message);
    	sync_send(message);
    }
}


function ledChanged(event){
	ledState = event.data.split(";");
    //console.log(ledState);
    for (var i = 0; i < ledState.length; i++){ 
    	$("#led"+i).css('background-color',colorArray[ledState[i]]);
    }
}

leds.onmessage = ledChanged;
leds.onerror = error;
leds.onclose = error;
leds.onopen = connection;

$(".state_arduino").removeClass("green");
$(".state_arduino").removeClass("red");
$(".state_arduino").addClass("yellow");

  //En cas d'erreur
  function error(){
    //alert("Connexion impossible");
    $(".state_arduino").removeClass("yellow");
    $(".state_arduino").removeClass("green");
    $(".state_arduino").addClass("red");
}

  //En cas de connexion réussi
  function connection(){
  	leds.send("/status");
  	$(".state_arduino").removeClass("yellow");
  	$(".state_arduino").removeClass("red");
  	$(".state_arduino").addClass("green");
    //alert("Connexion réussi");
}


  //Settings Panel

  $('.ui.accordion').accordion();

  
  function sauvegarder(){

    //Refresh value
    $("#ip").html($("#ip").val());
    $("#port").html($("#port").val());

    //Refresh tab
    $.tab('change tab', 'first');   
    $(".item_second").removeClass("active");
    $(".segment_second").removeClass("active");
    $(".item_first").addClass("active");
    $(".segment_first").addClass("active");

    //Save and Reload
    save_currentState();
    location.reload();
}

function save_currentState(){
	localStorage.setItem("leds_ip", $("#ip").val());
	localStorage.setItem("leds_port", $("#port").val());
}

</script>

</html>
